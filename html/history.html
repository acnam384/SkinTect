<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Scan History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css"/>
</head>
<body class="min-h-screen bg-[#F8F2DE] flex justify-center pt-12 px-4">

  <div class="w-full max-w-md bg-white p-6 sm:p-8 rounded-xl shadow-md space-y-4">
    <h2 class="text-xl font-bold text-primary text-center">Scan History</h2>

    <div id="historyContainer" class="space-y-2">
      <!-- JS will inject items here -->
    </div>

    <a href="homepage.html"
       class="mt-4 inline-block bg-button hover:brightness-110 text-white px-5 py-2 rounded-xl">
      ‚Üê Back to Home
    </a>
  </div>

  <!-- Confirmation Modal -->
  <div id="confirmModal"
       class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg space-y-4 w-80">
      <p class="text-center text-primary font-semibold">Delete this scan?</p>
      <div class="flex justify-around">
        <button id="cancelBtn"
                class="px-4 py-2 bg-gray-200 rounded-lg">Cancel</button>
        <button id="confirmBtn"
                class="px-4 py-2 bg-red-500 text-white rounded-lg">Delete</button>
      </div>
    </div>
  </div>

  <script>
    (()=>{
      const container = document.getElementById('historyContainer');
      let history = JSON.parse(localStorage.getItem('scan_history')||'[]');
      let toDelete = null;

      function render(){
        container.innerHTML = '';
        if(!history.length){
          container.innerHTML = '<p class="text-center text-gray-500">No scans yet.</p>';
          return;
        }
        history.forEach((entry, idx)=>{
          // badge color
          let badge = 'bg-gray-200 text-gray-800';
          if(entry.risk==='HIGH') badge='bg-red-200 text-red-800';
          else if(entry.risk==='MODERATE') badge='bg-yellow-200 text-yellow-800';
          else if(entry.risk==='LOW') badge='bg-green-200 text-green-800';

          // wrapper
          const item = document.createElement('div');
          item.className = 'relative overflow-hidden bg-white rounded-lg shadow p-3 mb-2';
          item.style.touchAction = 'pan-y';

          // swipe detection
          let startX=0;
          item.addEventListener('touchstart',e=>{
            startX=e.changedTouches[0].screenX;
          });
          item.addEventListener('touchend',e=>{
            const endX=e.changedTouches[0].screenX;
            if(startX-endX>50){
              content.style.transform='translateX(-3rem)';
              delBtn.classList.remove('hidden');
            }
          });

          // main content area (tappable)
          const content = document.createElement('div');
          content.className = 'flex justify-between items-center transition-transform duration-200 cursor-pointer';
          content.innerHTML = `
            <span class="text-sm font-medium text-primary">${entry.date}</span>
            <span class="inline-block px-2 py-1 rounded-full text-xs font-medium ${badge}">
              ${entry.risk.charAt(0)+entry.risk.slice(1).toLowerCase()}
            </span>
          `;

          // allergens list (hidden by default)
          const algList = document.createElement('ul');
          algList.className = 'mt-2 list-disc list-inside text-xs text-primary space-y-0.5 ml-4 hidden';
          entry.ingredients.forEach(ing=>{
            const li = document.createElement('li');
            li.textContent = ing;
            algList.appendChild(li);
          });

          // tapping content toggles allergens
          content.addEventListener('click', ()=>{
            algList.classList.toggle('hidden');
          });

          // delete button
          const delBtn = document.createElement('button');
          delBtn.className = 'absolute right-3 top-1/2 -translate-y-1/2 hidden text-red-600';
          delBtn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none"
                 viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round"
                    stroke-width="2"
                    d="M6 18L18 6M6 6l12 12" />
            </svg>
          `;
          delBtn.addEventListener('click', ()=>{
            toDelete = idx;
            document.getElementById('confirmModal').classList.remove('hidden');
          });

          item.appendChild(content);
          item.appendChild(algList);
          item.appendChild(delBtn);
          container.appendChild(item);
        });
      }
      // modal handlers
      document.getElementById('cancelBtn').onclick = ()=>{
        toDelete = null;
        document.getElementById('confirmModal').classList.add('hidden');
      };
      document.getElementById('confirmBtn').onclick = ()=>{
        if(toDelete!==null){
          history.splice(toDelete,1);
          localStorage.setItem('scan_history', JSON.stringify(history));
          render();
        }
        document.getElementById('confirmModal').classList.add('hidden');
      };

      render();
    })();
  </script>
</body>
</html>
